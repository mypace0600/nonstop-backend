# v2.5.18 이메일 인증 API 분리 계획

## 1. 변경 개요

### 문제점
현재 `POST /api/v1/auth/signup` API가 너무 많은 책임을 가지고 있음:
1. 입력 검증 (이메일/닉네임 중복 체크)
2. 만 14세 미만 제한
3. 사용자 정보 저장
4. **인증 코드 생성 + Redis 저장**
5. **이메일 발송**

### 해결 방안
**관심사 분리 (SRP)**: 회원가입과 이메일 인증을 별도 API로 분리

---

## 2. API 변경 사항

### 2.1 기존 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/v1/auth/signup` | 회원가입 + 이메일 인증 발송 |
| POST | `/api/v1/auth/signup/verify` | 인증 코드 확인 |
| POST | `/api/v1/auth/signup/resend` | 인증 코드 재발송 |

### 2.2 변경 후 API

| Method | Endpoint | 설명 | 변경 내용 |
|--------|----------|------|----------|
| POST | `/api/v1/auth/signup` | 회원가입만 | 이메일 발송 로직 제거 |
| POST | `/api/v1/auth/email/send-verification` | 이메일 인증 요청 | **신규** |
| POST | `/api/v1/auth/email/verify` | 인증 코드 확인 | 경로 변경 |
| ~~POST~~ | ~~`/api/v1/auth/signup/resend`~~ | ~~재발송~~ | **삭제** (send-verification으로 통합) |

---

## 3. 상세 변경 내용

### 3.1 `POST /api/v1/auth/signup` 변경

**Before:**
```java
public void signUp(SignUpRequestDto signUpRequest) {
    checkEmailDuplicate(signUpRequest.getEmail());
    checkNicknameDuplicate(signUpRequest.getNickname());
    validateAge(signUpRequest.getBirthDate());

    User user = signUpRequest.toEntity(passwordEncoder);
    authMapper.save(user);
    policyService.agreePolicies(user.getId(), signUpRequest.getAgreedPolicyIds());

    sendVerificationEmail(user.getEmail());  // 제거할 부분
}
```

**After:**
```java
public SignUpResponseDto signUp(SignUpRequestDto signUpRequest) {
    checkEmailDuplicate(signUpRequest.getEmail());
    checkNicknameDuplicate(signUpRequest.getNickname());
    validateAge(signUpRequest.getBirthDate());

    User user = signUpRequest.toEntity(passwordEncoder);
    authMapper.save(user);
    policyService.agreePolicies(user.getId(), signUpRequest.getAgreedPolicyIds());

    // 이메일 발송 제거 - 클라이언트가 별도 API 호출
    return new SignUpResponseDto(user.getId(), user.getEmail());
}
```

**Response 변경:**
```json
// Before
{ "message": "인증 메일이 발송되었습니다." }

// After
{ "userId": 123, "email": "user@example.com" }
```

### 3.2 `POST /api/v1/auth/email/send-verification` 신규

**Request:**
```json
{ "email": "user@example.com" }
```

**처리 로직:**
1. 해당 이메일 사용자 존재 확인 → 없으면 `404 USER_NOT_FOUND`
2. 이미 인증 완료 확인 → 완료면 `400 ALREADY_VERIFIED`
3. Rate Limit 확인 (1분) → 초과면 `429 RATE_LIMIT_EXCEEDED`
4. 인증 코드 생성 및 Redis 저장 (TTL 5분)
5. 이메일 발송

**Response:**
```json
{ "message": "인증 메일이 발송되었습니다." }
```

### 3.3 `POST /api/v1/auth/email/verify` 경로 변경

기존 `/api/v1/auth/signup/verify` → `/api/v1/auth/email/verify`

로직 변경 없음, 경로만 변경

### 3.4 `POST /api/v1/auth/signup/resend` 삭제

`/api/v1/auth/email/send-verification`이 재발송 역할도 수행하므로 삭제

---

## 4. 파일 변경 목록

### 4.1 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `AuthController.java` | API 엔드포인트 변경 |
| `AuthService.java` | 메서드 시그니처 변경 |
| `AuthServiceImpl.java` | 로직 분리 |

### 4.2 신규 파일

| 파일 | 설명 |
|------|------|
| `SignUpResponseDto.java` | 회원가입 응답 DTO |
| `EmailVerificationRequestDto.java` | 이메일 인증 요청 DTO |
| `AlreadyVerifiedException.java` | 이미 인증된 사용자 예외 |

### 4.3 삭제 파일

| 파일 | 사유 |
|------|------|
| `SignupResendRequestDto.java` | 새 DTO로 통합 |

---

## 5. 클라이언트 영향

### 5.1 회원가입 플로우 변경

**Before:**
```
1. POST /api/v1/auth/signup  → 회원가입 + 이메일 발송
2. 이메일 수신 대기
3. POST /api/v1/auth/signup/verify  → 인증
```

**After:**
```
1. POST /api/v1/auth/signup  → 회원가입만
2. POST /api/v1/auth/email/send-verification  → 이메일 발송 요청
3. 이메일 수신 대기
4. POST /api/v1/auth/email/verify  → 인증
```

### 5.2 재발송 플로우 변경

**Before:**
```
POST /api/v1/auth/signup/resend
```

**After:**
```
POST /api/v1/auth/email/send-verification  (동일 API 재사용)
```

---

## 6. 작업 순서

1. [ ] `SignUpResponseDto.java` 생성
2. [ ] `EmailVerificationRequestDto.java` 생성
3. [ ] `AlreadyVerifiedException.java` 생성
4. [ ] `AuthService.java` 인터페이스 수정
5. [ ] `AuthServiceImpl.java` 로직 분리
6. [ ] `AuthController.java` 엔드포인트 변경
7. [ ] `SignupResendRequestDto.java` 삭제
8. [ ] 테스트 코드 업데이트
9. [ ] PRD 문서 업데이트 (완료)

---

## 7. 장점

1. **관심사 분리**: 회원가입은 사용자 생성만, 이메일 인증은 별도 처리
2. **일관성**: 인증 요청/재발송이 동일 API로 통합
3. **유연성**: 이메일 발송 타이밍을 클라이언트가 제어 가능
4. **확장성**: 향후 다른 인증 방식(SMS 등) 추가 시 유사한 패턴 적용 가능
5. **에러 처리**: 회원가입 실패와 이메일 발송 실패를 분리하여 처리 가능
