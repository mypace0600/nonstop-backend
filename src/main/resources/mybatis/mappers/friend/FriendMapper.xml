<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.nonstop.domain.friend.mapper.FriendMapper">

    <resultMap id="friendResultMap" type="com.app.nonstop.domain.friend.entity.Friend">
        <id property="id" column="id"/>
        <result property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="status" column="status" javaType="com.app.nonstop.domain.friend.entity.FriendStatus"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>

    <resultMap id="userBlockResultMap" type="com.app.nonstop.domain.friend.entity.UserBlock">
        <result property="blockerId" column="blocker_id"/>
        <result property="blockedId" column="blocked_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- Friend -->
    <insert id="insertFriend" parameterType="com.app.nonstop.domain.friend.entity.Friend"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO friends (sender_id, receiver_id, status)
        VALUES (#{senderId}, #{receiverId}, #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler})
    </insert>

    <update id="updateFriendStatus" parameterType="com.app.nonstop.domain.friend.entity.Friend">
        UPDATE friends
        SET status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            updated_at = now()
        WHERE id = #{id}
    </update>

    <update id="softDeleteFriend">
        UPDATE friends
        SET deleted_at = now()
        WHERE id = #{id}
    </update>

    <select id="findFriendById" resultMap="friendResultMap">
        SELECT id, sender_id, receiver_id, status, created_at, updated_at, deleted_at
        FROM friends
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <select id="findFriendByUsers" resultMap="friendResultMap">
        SELECT id, sender_id, receiver_id, status, created_at, updated_at, deleted_at
        FROM friends
        WHERE LEAST(sender_id, receiver_id) = LEAST(#{userId1}, #{userId2})
          AND GREATEST(sender_id, receiver_id) = GREATEST(#{userId1}, #{userId2})
          AND deleted_at IS NULL
    </select>

    <select id="findReceivedFriendRequestsByUserId" resultType="com.app.nonstop.domain.friend.dto.FriendDto$FriendRequestResponseDto">
        SELECT
            f.id AS requestId,
            f.created_at AS requestedAt,
            u.id AS "requester.userId",
            u.nickname AS "requester.nickname",
            u.profile_image_url AS "requester.profileImageUrl"
        FROM friends f
        JOIN users u ON f.sender_id = u.id
        WHERE f.receiver_id = #{userId}
          AND f.status = 'WAITING'
          AND f.deleted_at IS NULL
        ORDER BY f.created_at DESC
    </select>

    <select id="findFriendsByUserId" resultType="com.app.nonstop.domain.friend.dto.FriendDto$FriendResponseDto">
        SELECT
            f.id AS friendshipId,
            f.updated_at AS becameFriendAt,
            friend_user.id AS "friend.userId",
            friend_user.nickname AS "friend.nickname",
            friend_user.profile_image_url AS "friend.profileImageUrl"
        FROM friends f
        JOIN users friend_user ON
            (CASE
                WHEN f.sender_id = #{userId} THEN f.receiver_id
                ELSE f.sender_id
            END) = friend_user.id
        WHERE (f.sender_id = #{userId} OR f.receiver_id = #{userId})
          AND f.status = 'ACCEPTED'
          AND f.deleted_at IS NULL
        ORDER BY becameFriendAt DESC
    </select>

    <!-- User Block -->
    <insert id="insertUserBlock" parameterType="com.app.nonstop.domain.friend.entity.UserBlock">
        INSERT INTO user_blocks (blocker_id, blocked_id)
        VALUES (#{blockerId}, #{blockedId})
    </insert>

    <select id="existsBlockByUsers" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM user_blocks
            WHERE blocker_id = #{blockerId} AND blocked_id = #{blockedId}
        )
    </select>

    <select id="findBlockByUsers" resultMap="userBlockResultMap">
        SELECT blocker_id, blocked_id, created_at
        FROM user_blocks
        WHERE blocker_id = #{blockerId} AND blocked_id = #{blockedId}
    </select>

</mapper>
