<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.nonstop.mapper.FriendMapper">

    <resultMap id="friendResultMap" type="com.app.nonstop.domain.friend.entity.Friend">
        <id property="id" column="id"/>
        <result property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="status" column="status" javaType="com.app.nonstop.domain.friend.entity.FriendStatus"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>

    <resultMap id="userBlockResultMap" type="com.app.nonstop.domain.friend.entity.UserBlock">
        <result property="blockerId" column="blocker_id"/>
        <result property="blockedId" column="blocked_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <resultMap id="friendRequestResponseResultMap" type="com.app.nonstop.domain.friend.dto.FriendDto$FriendRequestResponseDto">
        <id property="requestId" column="request_id"/>
        <result property="requestedAt" column="requested_at"/>
        <association property="requester" javaType="com.app.nonstop.domain.friend.dto.FriendDto$UserInfoDto">
            <id property="userId" column="requester_user_id"/>
            <result property="nickname" column="requester_nickname"/>
            <result property="profileImageUrl" column="requester_profile_image_url"/>
        </association>
    </resultMap>

    <resultMap id="friendResponseResultMap" type="com.app.nonstop.domain.friend.dto.FriendDto$FriendResponseDto">
        <id property="friendshipId" column="friendship_id"/>
        <result property="becameFriendAt" column="became_friend_at"/>
        <association property="friend" javaType="com.app.nonstop.domain.friend.dto.FriendDto$UserInfoDto">
            <id property="userId" column="friend_user_id"/>
            <result property="nickname" column="friend_nickname"/>
            <result property="profileImageUrl" column="friend_profile_image_url"/>
        </association>
    </resultMap>

    <resultMap id="blockedUserResponseResultMap" type="com.app.nonstop.domain.friend.dto.FriendDto$BlockedUserResponseDto">
        <result property="blockedAt" column="blocked_at"/>
        <association property="blockedUser" javaType="com.app.nonstop.domain.friend.dto.FriendDto$UserInfoDto">
            <id property="userId" column="blocked_user_id"/>
            <result property="nickname" column="blocked_nickname"/>
            <result property="profileImageUrl" column="blocked_profile_image_url"/>
        </association>
    </resultMap>

    <!-- Friend -->
    <insert id="insertFriend" parameterType="com.app.nonstop.domain.friend.entity.Friend"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO friends (sender_id, receiver_id, status)
        VALUES (#{senderId}, #{receiverId}, CAST(#{status} AS friend_status))
    </insert>

    <update id="updateFriendStatus" parameterType="com.app.nonstop.domain.friend.entity.Friend">
        UPDATE friends
        SET status = CAST(#{status} AS friend_status),
            updated_at = now()
        WHERE id = #{id}
    </update>

    <update id="softDeleteFriend">
        UPDATE friends
        SET deleted_at = now()
        WHERE id = #{id}
    </update>

    <select id="findFriendById" resultMap="friendResultMap">
        SELECT id, sender_id, receiver_id, status, created_at, updated_at, deleted_at
        FROM friends
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <select id="findFriendByUsers" resultMap="friendResultMap">
        SELECT id, sender_id, receiver_id, status, created_at, updated_at, deleted_at
        FROM friends
        WHERE LEAST(sender_id, receiver_id) = LEAST(#{userId1}, #{userId2})
          AND GREATEST(sender_id, receiver_id) = GREATEST(#{userId1}, #{userId2})
          AND deleted_at IS NULL
    </select>

    <select id="findReceivedFriendRequestsByUserId" resultMap="friendRequestResponseResultMap">
        SELECT
            f.id AS request_id,
            f.created_at AS requested_at,
            u.id AS requester_user_id,
            u.nickname AS requester_nickname,
            u.profile_image_url AS requester_profile_image_url
        FROM friends f
        JOIN users u ON f.sender_id = u.id
        WHERE f.receiver_id = #{userId}
          AND f.status = 'WAITING'
          AND f.deleted_at IS NULL
        ORDER BY f.created_at DESC
    </select>

    <select id="findFriendsByUserId" resultMap="friendResponseResultMap">
        SELECT
            f.id AS friendship_id,
            f.updated_at AS became_friend_at,
            friend_user.id AS friend_user_id,
            friend_user.nickname AS friend_nickname,
            friend_user.profile_image_url AS friend_profile_image_url
        FROM friends f
        JOIN users friend_user ON
            (CASE
                WHEN f.sender_id = #{userId} THEN f.receiver_id
                ELSE f.sender_id
            END) = friend_user.id
        WHERE (f.sender_id = #{userId} OR f.receiver_id = #{userId})
          AND f.status = 'ACCEPTED'
          AND f.deleted_at IS NULL
        ORDER BY became_friend_at DESC
    </select>

    <!-- User Block -->
    <insert id="insertUserBlock" parameterType="com.app.nonstop.domain.friend.entity.UserBlock">
        INSERT INTO user_blocks (blocker_id, blocked_id)
        VALUES (#{blockerId}, #{blockedId})
    </insert>

    <select id="existsBlockByUsers" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM user_blocks
            WHERE blocker_id = #{blockerId} AND blocked_id = #{blockedId}
        )
    </select>

    <select id="findBlockByUsers" resultMap="userBlockResultMap">
        SELECT blocker_id, blocked_id, created_at
        FROM user_blocks
        WHERE blocker_id = #{blockerId} AND blocked_id = #{blockedId}
    </select>

    <delete id="deleteUserBlock">
        DELETE FROM user_blocks
        WHERE blocker_id = #{blockerId} AND blocked_id = #{blockedId}
    </delete>

    <select id="findBlockedUsersByBlockerId" resultMap="blockedUserResponseResultMap">
        SELECT
            ub.created_at AS blocked_at,
            u.id AS blocked_user_id,
            u.nickname AS blocked_nickname,
            u.profile_image_url AS blocked_profile_image_url
        FROM user_blocks ub
        JOIN users u ON ub.blocked_id = u.id
        WHERE ub.blocker_id = #{blockerId}
        ORDER BY ub.created_at DESC
    </select>

</mapper>
