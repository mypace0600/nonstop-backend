<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.nonstop.domain.user.mapper.UserMapper">

    <!--
        [ResultMap: userWithDetailsMap]
        데이터베이스의 플랫한(flat) 조회 결과(JOIN 포함)를 중첩된(nested) 자바 객체 구조로 매핑합니다.
        - <id>: PK 컬럼을 명시합니다.
        - <result>: 일반 컬럼을 객체 필드에 매핑합니다.
        - <association>: 1:1 관계의 다른 객체(University, Major)를 매핑합니다.
        - typeHandler: MyBatis가 Java의 Enum 타입과 DB의 문자열 타입을 변환할 수 있도록 핸들러를 지정합니다.
    -->
    <resultMap id="userWithDetailsMap" type="com.app.nonstop.domain.user.entity.User">
        <id property="id" column="user_id"/>
        <result property="userRole" column="user_role" javaType="com.app.nonstop.domain.user.entity.UserRole"/>
        <result property="email" column="user_email"/>
        <result property="password" column="user_password"/>
        <result property="authProvider" column="user_auth_provider" javaType="com.app.nonstop.domain.user.entity.AuthProvider"/>
        <result property="nickname" column="user_nickname"/>
        <result property="studentNumber" column="user_student_number"/>
        <result property="universityId" column="user_university_id"/> <!-- Added -->
        <result property="majorId" column="user_major_id"/>           <!-- Added -->
        <result property="profileImageUrl" column="user_profile_image_url"/>
        <result property="introduction" column="user_introduction"/>
        <result property="preferredLanguage" column="user_preferred_language"/>
        <result property="isActive" column="user_is_active"/>
        <result property="isVerified" column="user_is_verified"/>
        <result property="verificationMethod" column="user_verification_method" javaType="com.app.nonstop.domain.user.entity.VerificationMethod"/>
        <result property="lastLoginAt" column="user_last_login_at"/>
        <result property="deletedAt" column="user_deleted_at"/>
        <result property="createdAt" column="user_created_at"/>
        <result property="updatedAt" column="user_updated_at"/>
        <association property="university" javaType="com.app.nonstop.domain.university.entity.University">
            <id property="id" column="uni_id"/>
            <result property="name" column="uni_name"/>
            <result property="region" column="uni_region"/>
            <result property="logoImageUrl" column="uni_logo_image_url"/>
            <result property="createdAt" column="uni_created_at"/>
        </association>
        <association property="major" javaType="com.app.nonstop.domain.major.entity.Major">
            <id property="id" column="major_id"/>
            <result property="universityId" column="major_university_id"/>
            <result property="name" column="major_name"/>
        </association>
    </resultMap>

    <!--
        [Select: findById]
        사용자 ID로 상세 정보를 조회합니다.
        - LEFT JOIN: 사용자가 대학이나 전공 정보를 아직 등록하지 않았더라도(NULL 이더라도) 조회 결과에 포함시키기 위해 사용합니다.
                     INNER JOIN을 사용하면 대학/전공 정보가 없는 사용자는 조회되지 않습니다.
        - Alias(AS): 여러 테이블에 동일한 컬럼명(id, name 등)이 존재하므로, 별칭을 사용하여 resultMap에서 명확하게 구분합니다.
        - Soft Delete: deleted_at IS NULL 조건을 추가하여 탈퇴한 사용자는 조회 대상에서 제외합니다.
    -->
    <select id="findById" resultMap="userWithDetailsMap">
        SELECT
            u.id AS user_id,
            u.user_role AS user_role,
            u.email AS user_email,
            u.password AS user_password,
            u.auth_provider AS user_auth_provider,
            u.nickname AS user_nickname,
            u.student_number AS user_student_number,
            u.university_id AS user_university_id, <!-- Added -->
            u.major_id AS user_major_id,           <!-- Added -->
            u.profile_image_url AS user_profile_image_url,
            u.introduction AS user_introduction,
            u.preferred_language AS user_preferred_language,
            u.is_active AS user_is_active,
            u.is_verified AS user_is_verified,
            u.verification_method AS user_verification_method,
            u.last_login_at AS user_last_login_at,
            u.deleted_at AS user_deleted_at,
            u.created_at AS user_created_at,
            u.updated_at AS user_updated_at,
            
            uni.id AS uni_id,
            uni.name AS uni_name,
            uni.region AS uni_region,
            uni.logo_image_url AS uni_logo_image_url,
            uni.created_at AS uni_created_at,

            m.id AS major_id,
            m.university_id AS major_university_id,
            m.name AS major_name
        FROM 
            users u
        LEFT JOIN 
            universities uni ON u.university_id = uni.id
        LEFT JOIN 
            majors m ON u.major_id = m.id
        WHERE 
            u.id = #{id}
            AND u.deleted_at IS NULL
    </select>

    <!--
        [Select: existsByNickname]
        주어진 닉네임이 탈퇴하지 않은 사용자들 중에서 존재하는지 확인합니다.
        - 닉네임 중복 방지 로직에 사용됩니다.
    -->
    <select id="existsByNickname" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM users
            WHERE nickname = #{nickname} AND deleted_at IS NULL
        )
    </select>

    <!--
        [Update: updateProfile]
        사용자의 프로필 정보를 업데이트합니다.
        - <set>: DTO에서 null이 아닌 필드만 동적으로 UPDATE 쿼리에 포함시킵니다.
        - updated_at: 프로필이 수정될 때마다 현재 시간으로 자동 갱신됩니다.
    -->
    <update id="updateProfile">
        UPDATE users
        <set>
            <if test="nickname != null">
                nickname = #{nickname},
            </if>
            <if test="universityId != null">
                university_id = #{universityId},
            </if>
            <if test="majorId != null">
                major_id = #{majorId},
            </if>
            <if test="university != null and university.id != null">
                university_id = #{university.id},
            </if>
            <if test="major != null and major.id != null">
                major_id = #{major.id},
            </if>
            <if test="profileImageUrl != null">
                profile_image_url = #{profileImageUrl},
            </if>
            <if test="introduction != null">
                introduction = #{introduction},
            </if>
            <if test="preferredLanguage != null">
                preferred_language = #{preferredLanguage},
            </if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!--
        [Update: updatePassword]
        사용자의 비밀번호를 업데이트합니다.
        - 비밀번호 변경 시 updated_at 필드도 함께 갱신합니다.
    -->
    <update id="updatePassword">
        UPDATE users
        SET
            password = #{newPassword},
            updated_at = NOW()
        WHERE
            id = #{userId}
    </update>

    <!--
        [Update: softDelete]
        사용자 계정을 비활성화(soft delete)합니다.
        - 실제 데이터를 삭제하는 대신 deleted_at 필드에 현재 시간을 기록합니다.
    -->
    <update id="softDelete">
        UPDATE users
        SET
            deleted_at = NOW()
        WHERE
            id = #{userId}
    </update>

    <select id="findByEmail" resultMap="userWithDetailsMap">
        SELECT
            u.id AS user_id,
            u.user_role AS user_role,
            u.email AS user_email,
            u.password AS user_password,
            u.auth_provider AS user_auth_provider,
            u.nickname AS user_nickname,
            u.student_number AS user_student_number,
            u.university_id AS user_university_id, <!-- Added -->
            u.major_id AS user_major_id,           <!-- Added -->
            u.profile_image_url AS user_profile_image_url,
            u.introduction AS user_introduction,
            u.preferred_language AS user_preferred_language,
            u.is_active AS user_is_active,
            u.is_verified AS user_is_verified,
            u.verification_method AS user_verification_method,
            u.last_login_at AS user_last_login_at,
            u.deleted_at AS user_deleted_at,
            u.created_at AS user_created_at,
            u.updated_at AS user_updated_at,

            uni.id AS uni_id,
            uni.name AS uni_name,
            uni.region AS uni_region,
            uni.logo_image_url AS uni_logo_image_url,
            uni.created_at AS uni_created_at,

            m.id AS major_id,
            m.university_id AS major_university_id,
            m.name AS major_name
        FROM
            users u
        LEFT JOIN
            universities uni ON u.university_id = uni.id
        LEFT JOIN
            majors m ON u.major_id = m.id
        WHERE
            u.email = #{email}
            AND u.deleted_at IS NULL
    </select>

    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (email, nickname, profile_image_url, user_role, auth_provider, provider_id)
        VALUES (#{email}, #{nickname}, #{profileImageUrl}, #{userRole, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{authProvider, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{providerId})
    </insert>

    <update id="updateUser">
        UPDATE users
        SET
            nickname = #{nickname},
            profile_image_url = #{profileImageUrl},
            updated_at = NOW()
        WHERE
            id = #{id}
    </update>

</mapper>