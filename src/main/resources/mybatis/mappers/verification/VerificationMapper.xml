<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.nonstop.domain.verification.mapper.VerificationMapper">

    <resultMap id="verificationRequestResultMap" type="com.app.nonstop.domain.verification.entity.StudentVerificationRequest">
        <id property="id" column="req_id"/>
        <result property="imageUrl" column="req_image_url"/>
        <result property="status" column="req_status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="rejectReason" column="req_reject_reason"/>
        <result property="reviewedAt" column="req_reviewed_at"/>
        <result property="createdAt" column="req_created_at"/>
        <result property="updatedAt" column="req_updated_at"/>
        <association property="user" javaType="com.app.nonstop.domain.user.entity.User">
            <id property="id" column="user_id"/>
        </association>
        <association property="reviewedBy" javaType="com.app.nonstop.domain.user.entity.User">
            <id property="id" column="reviewed_by_id"/>
        </association>
    </resultMap>

    <!--
        [Select: findPendingRequestByUserId]
        특정 사용자의 현재 처리 대기 중(PENDING)인 학생증 인증 요청을 조회합니다.
        - `user_id`와 `status = 'PENDING'` 조건을 사용하여, 사용자가 이미 진행 중인 요청을 가지고 있는지 확인합니다.
        - `LIMIT 1`을 사용하여 최신 또는 하나의 요청만 가져오도록 최적화합니다.
    -->
    <select id="findPendingRequestByUserId" resultMap="verificationRequestResultMap">
        SELECT
            id AS req_id,
            user_id,
            image_url AS req_image_url,
            status AS req_status,
            reject_reason AS req_reject_reason,
            reviewed_by AS reviewed_by_id,
            reviewed_at AS req_reviewed_at,
            created_at AS req_created_at,
            updated_at AS req_updated_at
        FROM
            student_verification_requests
        WHERE
            user_id = #{userId} AND status = 'PENDING'
        LIMIT 1
    </select>

    <!--
        [Insert: save]
        새로운 학생증 인증 요청 정보를 저장합니다.
        - `user_id`, `image_url`, 초기 `status`를 `PENDING`으로 설정하여 저장합니다.
        - `useGeneratedKeys="true" keyProperty="id"`: DB에서 자동 생성된 ID를 StudentVerificationRequest 객체의 id 필드에 주입합니다.
    -->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO student_verification_requests (user_id, image_url, status, created_at, updated_at)
        VALUES (#{user.id}, #{imageUrl}, #{status}, NOW(), NOW())
    </insert>

</mapper>
